; new protocol for servo-ctl
;00 header, 'S'
;01 head-ext, 0
;02 numchan, 12
;03 chan 0, 1
;06 chan 2, 3
;09 chan 4, 5
;0C chan 6, 7
;0F chan 8, 9
;12 chan 10, 11
;15 crc


;# python code to make the coding table
;def make_looptable():
; looptab = list()
; outtab = list()
; poly = 0x1FA & 0xFF
; for t in xrange(256):
;  sr=t
;  outVal=0
;  for s in xrange(8):
;   outVal = outVal<<1
;   if (sr&1):
;    sr=(sr>>1)^poly
;    outVal+=1
;   else:
;    sr=sr>>1
;  looptab.append(sr)
;  outtab.append(outVal)
; return looptab,outtab
;
;lt,ot = make_looptable()
;l = list("0x34%02X"%i for i in lt)
;for j in xrange(0,256,16):
; print 'dw '+','.join(l[j:j+16])
;
;s = set()
;st = 1
;for x in xrange(1000):
; st = lt[(st^57)&255]
; s.add(st)
;
;print len(s)
;if len(s) != 255:
; print "OOps."


l_CRCstate = 0x2*  ; CRC register


toCRC:
	; takes 2+10 clocks.
	xorwf l_CRCstate,0
	call _pollCRCtab
	movwf l_CRCstate
	return

_pollCRCtab:
	brw
	dw 0x3400,0x34C2,0x3471,0x34B3,0x34E2,0x3420,0x3493,0x3451,0x3431,0x34F3,0x3440,0x3482,0x34D3,0x3411,0x34A2,0x3460
	dw 0x3462,0x34A0,0x3413,0x34D1,0x3480,0x3442,0x34F1,0x3433,0x3453,0x3491,0x3422,0x34E0,0x34B1,0x3473,0x34C0,0x3402
	dw 0x34C4,0x3406,0x34B5,0x3477,0x3426,0x34E4,0x3457,0x3495,0x34F5,0x3437,0x3484,0x3446,0x3417,0x34D5,0x3466,0x34A4
	dw 0x34A6,0x3464,0x34D7,0x3415,0x3444,0x3486,0x3435,0x34F7,0x3497,0x3455,0x34E6,0x3424,0x3475,0x34B7,0x3404,0x34C6
	dw 0x347D,0x34BF,0x340C,0x34CE,0x349F,0x345D,0x34EE,0x342C,0x344C,0x348E,0x343D,0x34FF,0x34AE,0x346C,0x34DF,0x341D
	dw 0x341F,0x34DD,0x346E,0x34AC,0x34FD,0x343F,0x348C,0x344E,0x342E,0x34EC,0x345F,0x349D,0x34CC,0x340E,0x34BD,0x347F
	dw 0x34B9,0x347B,0x34C8,0x340A,0x345B,0x3499,0x342A,0x34E8,0x3488,0x344A,0x34F9,0x343B,0x346A,0x34A8,0x341B,0x34D9
	dw 0x34DB,0x3419,0x34AA,0x3468,0x3439,0x34FB,0x3448,0x348A,0x34EA,0x3428,0x349B,0x3459,0x3408,0x34CA,0x3479,0x34BB
	dw 0x34FA,0x3438,0x348B,0x3449,0x3418,0x34DA,0x3469,0x34AB,0x34CB,0x3409,0x34BA,0x3478,0x3429,0x34EB,0x3458,0x349A
	dw 0x3498,0x345A,0x34E9,0x342B,0x347A,0x34B8,0x340B,0x34C9,0x34A9,0x346B,0x34D8,0x341A,0x344B,0x3489,0x343A,0x34F8
	dw 0x343E,0x34FC,0x344F,0x348D,0x34DC,0x341E,0x34AD,0x346F,0x340F,0x34CD,0x347E,0x34BC,0x34ED,0x342F,0x349C,0x345E
	dw 0x345C,0x349E,0x342D,0x34EF,0x34BE,0x347C,0x34CF,0x340D,0x346D,0x34AF,0x341C,0x34DE,0x348F,0x344D,0x34FE,0x343C
	dw 0x3487,0x3445,0x34F6,0x3434,0x3465,0x34A7,0x3414,0x34D6,0x34B6,0x3474,0x34C7,0x3405,0x3454,0x3496,0x3425,0x34E7
	dw 0x34E5,0x3427,0x3494,0x3456,0x3407,0x34C5,0x3476,0x34B4,0x34D4,0x3416,0x34A5,0x3467,0x3436,0x34F4,0x3447,0x3485
	dw 0x3443,0x3481,0x3432,0x34F0,0x34A1,0x3463,0x34D0,0x3412,0x3472,0x34B0,0x3403,0x34C1,0x3490,0x3452,0x34E1,0x3423
	dw 0x3421,0x34E3,0x3450,0x3492,0x34C3,0x3401,0x34B2,0x3470,0x3410,0x34D2,0x3461,0x34A3,0x34F2,0x3430,0x3483,0x3441
